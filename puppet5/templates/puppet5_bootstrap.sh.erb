#!/bin/sh

# This file sets up our Puppet 3 client configuration.

export PATH='/usr/local/rvm/bin:/opt/jdk/bin:/opt/ruby/bin:/usr/bin:/usr/sbin:/bin:/sbin',

# We need puppet for the system accounts; we could do it ourselves but this is easy
#yum install -y puppet wget
yum install wget -y

cd /tmp

if [ ! "$(/usr/local/rvm/bin/rvm --version | grep '<%= @tools_rvm_version %>')" ]
then
  for num in $(seq 1 10)
  do
    /usr/bin/curl -L https://get.rvm.io | bash -s <%= @tools_rvm_version %> && break
  done
  /usr/local/rvm/bin/rvm cleanup sources
fi

# RVM install requirements
yum install -y libyaml-devel autoconf readline-devel libffi-devel openssl-devel bzip2 automake libtool bison sqlite-devel
yum downgrade -y libyaml-devel autoconf readline-devel libffi-devel openssl-devel bzip2 automake libtool bison sqlite-devel
yum install -y libyaml-devel autoconf readline-devel libffi-devel openssl-devel bzip2 automake libtool bison sqlite-devel

#for num in $(seq 1 10)
#do
#  wget http://prod-deploy.cytobank.cn/rvm/<%= @tools_ruby_version %>.tar.bz2 -O /usr/local/rvm/archives/ruby-2.0.0-p648.tar.bz2 && break
#done

if [ ! "$(/usr/local/rvm/bin/rvm list | grep '<%= @tools_ruby_version %>')" ]
then
  for num in $(seq 1 10)
  do
    /usr/local/rvm/bin/rvm install '<%= @tools_ruby_version %>' && break
  done
fi

if [ ! "$(/usr/local/rvm/bin/rvm '<%= @tools_ruby_version %>' gemset list | grep puppet5)" ]
then
  for num in $(seq 1 10)
  do
    /usr/local/rvm/bin/rvm '<%= @tools_ruby_version %>' 'do' rvm gemset create puppet5 && break
  done
fi

for num in $(seq 1 10)
do
  /usr/local/rvm/bin/rvm '<%= @tools_ruby_version %>@puppet5' 'do' gem install puppet -v '5.5.21' --no-document && break
done
for num in $(seq 1 10)
do
  '/usr/local/rvm/wrappers/<%= @tools_ruby_version %>@puppet5/gem' install deep_merge --no-document && break
done
for num in $(seq 1 10)
do
  '/usr/local/rvm/wrappers/<%= @tools_ruby_version %>@puppet5/gem' install ruby-shadow --no-document && break
done

mkdir -p '/opt/puppet5' '/opt/puppet5/etc' '/opt/puppet5/var'
chown puppet:puppet '/opt/puppet5' '/opt/puppet5/etc' '/opt/puppet5/var'
chmod 755 '/opt/puppet5' '/opt/puppet5/etc' '/opt/puppet5/var'

cat >'/opt/puppet5/etc/puppet.conf' <<EOF
[main]
  vardir = /opt/puppet5/var
  confdir = /opt/puppet5/etc
  ssldir = /opt/puppet5/ssl
  configtimeout = 600
EOF

cat >'/usr/local/bin/puppet5' <<EOF
#!/bin/sh

'/usr/local/rvm/wrappers/<%= @tools_ruby_version %>@puppet5/ruby' '/usr/local/rvm/gems/<%= @tools_ruby_version %>@puppet5/bin/puppet' agent -tv --server puppetmaster.example.com --confdir /opt/puppet5/etc
EOF

chown puppet:puppet '/opt/puppet5/etc/puppet.conf' '/usr/local/bin/puppet5'
chmod 644 '/opt/puppet5/etc/puppet.conf'
chmod 755 '/usr/local/bin/puppet5'
