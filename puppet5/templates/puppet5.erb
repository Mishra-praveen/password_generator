#!/bin/bash

<%-
  puppetmaster = @hosts.keys.select { |x| @hosts[x]['type'] == 'puppetmaster' }.first
  puppetmasterip = @hosts[puppetmaster]['ips'].first
-%>

export LANG=en_US.UTF-8
export LANGUAGE=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export LC_COLLATE=C

version="<%= @tools_ruby_version %>@puppet5"
# Fallback in case of install problems
if [ ! -f "/usr/local/rvm/wrappers/$version/ruby" -o ! -f "/usr/local/rvm/gems/$version/bin/puppet" ]
then
  version="ruby-2.0.0-p648@puppet5"
fi

if [ ! "$FACTER_fqdn" ]
then
  export FACTER_fqdn="<%= @host_fqdn %>"
fi

# Hack for CentOS 7. operatingsystemrelease includes third part of release version eg 7.2.1511
if [[ "$(/usr/local/bin/facter5 operatingsystem)" == "CentOS" && "$(/usr/local/bin/facter5 operatingsystemmajrelease)" == "7" ]]
then
  export FACTER_operatingsystemrelease=$(/usr/local/bin/facter5 operatingsystemmajrelease).$(/usr/local/bin/facter5 --json os | grep minor | awk '{ print $2 }' | tr '",' ' ' | sed -e 's/ //g')
fi

lastexit=127

if [ "$1" == "special" ]
then
  shift
  /usr/local/rvm/wrappers/$version/ruby /usr/local/rvm/gems/$version/bin/puppet "$@"
else
  for num in 1 2 3 4 5 6
  do
    # If we're doing an agent run, check for a lock.  If we can't
    # lock, we don't want to write the last run file.
    if [[ "$*" == "" || "$*" == "* agent*" ]]
    then
      if find /opt/puppet5/var/state/agent_catalog_run.lock -mmin -30 2>/dev/null | grep -q /opt/puppet5/var/state/agent_catalog_run.lock
      then
        echo "Someone else has locked puppet.  Bailing."
        exit 13
      else
        # The lock is either gone or old; destroy it just in case
        rm -f /opt/puppet5/var/state/agent_catalog_run.lock >/dev/null 2>&1
      fi
    fi

    if [ ! "$*" ]
    then
      /usr/local/rvm/wrappers/$version/ruby /usr/local/rvm/gems/$version/bin/puppet agent -tv --server <%= puppetmasterip %> --certname='<%= @host_fqdn %>' --no-usecacheonfailure --confdir /opt/puppet5/etc 2>&1 | tee /tmp/last_puppet_run.log
      lastexit=$?
    else
      /usr/local/rvm/wrappers/$version/ruby /usr/local/rvm/gems/$version/bin/puppet "$@" --server <%= puppetmasterip %> --certname='<%= @host_fqdn %>' --no-usecacheonfailure --confdir /opt/puppet5/etc 2>&1 | tee /tmp/last_puppet_run.log
      lastexit=$?
    fi

    if grep -q 'execution expired' /tmp/last_puppet_run.log
    then
      echo 'Puppet run failed due to execution expired; retrying.'
    else
      break
    fi
  done
fi

# There's a bug where puppet sometimes acts as though
# detailed-exitcodes was on when it isn't; this deals with that.
if [ "$lastexit" -eq 2 ]
then
  lastexit=0
fi

if grep -q 'Could not retrieve catalog' /tmp/last_puppet_run.log
then
  lastexit=10
fi

if grep -q 'failed catalog' /tmp/last_puppet_run.log
then
  lastexit=11
fi

if grep -iq 'Failed to apply catalog' /tmp/last_puppet_run.log
then
  lastexit=12
fi

exit $lastexit
